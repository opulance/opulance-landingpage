name: publish-to-github-pages
on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4

      - name: Setup Node.js ‚öôÔ∏è - Cache dependencies ‚ö° - Install dependencies üîß
        uses: ./.github/workflows/setup-node

      - name: Setup Pages ‚öôÔ∏è
        uses: actions/configure-pages@v4
        with:
          static_site_generator: next

      - name: Build with Next.js üèóÔ∏è
        run: |
          # Clean any existing output
          rm -rf out
          
          # Build Next.js project
          npm run build
          
          # Extended debug output
          echo "File structure after build:"
          find . -type d -maxdepth 2 | sort
          
          # Ensure export was created properly, use explicit export if needed
          if [ -d "out" ] && [ "$(find out -type f -not -path "*/\.*" | wc -l)" -lt 2 ]; then
            echo "Standard export produced empty or missing out directory, trying explicit export..."
            # Try explicit export command if the normal build didn't create files
            npx next export || true
          fi
          
          # Ensure out directory exists
          mkdir -p out
          
          # Create .nojekyll file
          touch out/.nojekyll
          
          # Look for the built files in various locations
          if [ "$(find out -type f -not -path "*/\.*" | wc -l)" -lt 2 ]; then
            echo "Looking for the exported files in other locations..."
            
            # Check if export was created in a different directory
            if [ -d "_next" ]; then
              echo "Found _next directory at root, copying..."
              cp -r _next out/
            fi
            
            if [ -d ".next" ]; then
              echo "Found .next directory, examining contents..."
              find .next -type f -maxdepth 3 | head -10
              
              if [ -d ".next/static" ]; then
                echo "Found .next/static, copying to out/_next/static..."
                mkdir -p out/_next
                cp -r .next/static out/_next/
              fi
            fi
            
            # Check for export-related directories
            for dir in public static assets; do
              if [ -d "$dir" ]; then
                echo "Copying $dir directory to out..."
                cp -r $dir out/
              fi
            done
            
            # Look for HTML files
            echo "Looking for HTML files..."
            find . -name "*.html" -maxdepth 2
            
            # Copy HTML files if found
            find . -name "*.html" -maxdepth 2 -exec cp {} out/ \;
            
            # Create a minimal index.html if none exists
            if [ ! -f "out/index.html" ]; then
              echo "Creating minimal index.html..."
              echo '<html><head><meta http-equiv="refresh" content="0;URL=/opulance-landingpage/index.html"></head><body>Redirecting...</body></html>' > out/index.html
            fi
          fi
          
          # Final debugging output
          echo "Final out directory contents:"
          find out -type f | sort
          echo "Total files in out directory: $(find out -type f | wc -l)"

      - name: Upload artifact üì°
        uses: actions/upload-pages-artifact@v3
        with:
          path: out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Publish to GitHub Pages üöÄ
        id: deployment
        uses: actions/deploy-pages@v4